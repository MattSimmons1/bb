<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>bb</title>
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&display=swap" rel="stylesheet">
</head>

<style>
	body {
		margin: 40px 100px;
		background: #fff;
		color: #111214;
		font-family: 'Lato', sans-serif;
		font-weight: lighter;
	}
	a {
		color: #bebeee;
	}
	.main {
	}
	#bbInput, #jsonOutput {
		color: #fff;
    background: #111214;
		border: none;
		border-radius: 10px;
		padding: 20px;
		margin: 0;
	}
	.input {
		width: auto;
	}
	#jsonOutput {
		color: #111214;
		background: #bebeee;
		min-height: 300px;
	}
	.output {
		width: 700px;
		max-height: 300px;
		border-radius: 10px;
		overflow: scroll;
	}
</style>
<h1><a href="../">bb</a> playground</h1>
<p>Write some bb in the box below:</p>
<div class="main">
	<div class="input"><textarea id="bbInput" name="bbInput" rows="14" cols="80" onchange="convert();">
a = { type: apple, price: d => "$" + (d.quantity * 0.50).toFixed(2) }
b = { type: banana, *: colour }

9a b*`yellow` 4b*`green`
</textarea>
	</div>
	<p>JSON Output</p>
  <div class="output"><pre id="jsonOutput"></pre></div>
</div>

	<script src="js/wasm_exec.js"></script>
	<script>
		if (!WebAssembly.instantiateStreaming) { // polyfill
			WebAssembly.instantiateStreaming = async (resp, importObject) => {
				const source = await (await resp).arrayBuffer();
				return await WebAssembly.instantiate(source, importObject);
			};
		}

		wasm = {};  // create a global object that I can attach functions to from go

		const go = new Go();
		let mod, inst;
		WebAssembly.instantiateStreaming(fetch("bb.wasm"), go.importObject).then((result) => {
			mod = result.module;
			inst = result.instance;
		}).catch((err) => {
			console.error(err);
		}).then(init)

		async function init() {
			await go.run(inst);  // this runs the init() function of bb.go

			inst = await WebAssembly.instantiate(mod, go.importObject); // reset instance
		}

  var output;
	//
	// playground
	//
  function convert() {

  	if (!wasm.bb) {
  		setTimeout(convert, 10);
			return
		}

		const input = document.getElementById("bbInput").value;
		console.log("convert");
		console.log(input);
		output = wasm.bb(input);
		console.log(output);

		if (typeof(output) === "undefined") {
			const go = new Go();
			let mod, inst;
			WebAssembly.instantiateStreaming(fetch("bb.wasm"), go.importObject).then((result) => {
				mod = result.module;
				inst = result.instance;
			}).catch((err) => {
				console.error(err);
			}).then(init);
			output = "Syntax Error - bb couldn't parse the input.";
		}

		document.getElementById("jsonOutput").innerText = JSON.stringify(output, null, 2);

	}

  document.getElementById("bbInput").oninput=convert;
	convert()

</script>
</body>

</html>